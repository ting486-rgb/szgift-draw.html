<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ§ª åœ£è¯æŠ½ç­¾ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1ï¼šç”¨æˆ·ä¸ä¼šæŠ½åˆ°è‡ªå·±çš„å¿ƒæ„¿</h2>
        <button onclick="testSelfWishPrevention()">å¼€å§‹æµ‹è¯•</button>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2ï¼šæ•°æ®åŒæ­¥å’ŒåŒ¹é…</h2>
        <button onclick="testDataSync()">å¼€å§‹æµ‹è¯•</button>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3ï¼šç®¡ç†å‘˜é‡ç½®æƒé™</h2>
        <button onclick="testAdminReset()">å¼€å§‹æµ‹è¯•</button>
        <div id="test3-result"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
        const users = [
            { id: 'admin', name: 'ç®¡ç†å‘˜', wish: 'ç®¡ç†ç³»ç»Ÿ', isAdmin: true },
            { id: 'liztang', name: 'å”ä¸½ä¸½', wish: 'æ¸©é¦¨çš„ç¤¼ç‰©' },
            { id: 'tingtingong', name: 'é¾”å©·', wish: 'å®ç”¨çš„ è®©äººè½»æ¾çš„ å¹¸ç¦æ„Ÿæå‡çš„' },
            { id: 'mandycfhe', name: 'ä½•ç¿ èŠ³', wish: 'éšæ„' }
        ];

        function testSelfWishPrevention() {
            const resultDiv = document.getElementById('test1-result');
            let testResults = [];
            
            // æ¨¡æ‹Ÿæ¯ä¸ªç”¨æˆ·çš„æŠ½ç­¾é€»è¾‘
            users.forEach(user => {
                if (!user.isAdmin) {
                    // æ¨¡æ‹ŸæŠ½ç­¾ç®—æ³•
                    const availableWishes = users
                        .filter(u => u.id !== user.id && !u.isAdmin)
                        .map(u => u.wish);
                    
                    const canDrawOwnWish = availableWishes.includes(user.wish);
                    testResults.push({
                        user: user.name,
                        canDrawOwn: canDrawOwnWish,
                        availableCount: availableWishes.length
                    });
                }
            });
            
            const allPassed = testResults.every(result => !result.canDrawOwn);
            
            let html = `<div class="${allPassed ? 'success' : 'error'}">`;
            html += `<strong>æµ‹è¯•ç»“æœï¼š${allPassed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br>`;
            testResults.forEach(result => {
                html += `${result.user}: ${result.canDrawOwn ? 'âŒ å¯èƒ½æŠ½åˆ°è‡ªå·±' : 'âœ… ä¸ä¼šæŠ½åˆ°è‡ªå·±'} (å¯é€‰å¿ƒæ„¿æ•°: ${result.availableCount})<br>`;
            });
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }

        function testDataSync() {
            const resultDiv = document.getElementById('test2-result');
            
            // æµ‹è¯•localStorageçš„å±€é™æ€§
            const roomCode = 'TEST123';
            const storageKey = `giftDrawRecords_${roomCode}`;
            
            // æ¨¡æ‹Ÿä¸åŒç”¨æˆ·çš„æŠ½ç­¾
            const testRecords = {
                'liztang': { wish: 'å®ç”¨çš„ è®©äººè½»æ¾çš„ å¹¸ç¦æ„Ÿæå‡çš„', timestamp: new Date().toLocaleString() },
                'tingtingong': { wish: 'æ¸©é¦¨çš„ç¤¼ç‰©', timestamp: new Date().toLocaleString() }
            };
            
            localStorage.setItem(storageKey, JSON.stringify(testRecords));
            const retrieved = JSON.parse(localStorage.getItem(storageKey));
            
            let html = '<div class="warning">';
            html += '<strong>âš ï¸ æ•°æ®åŒæ­¥é—®é¢˜åˆ†æï¼š</strong><br>';
            html += '1. å½“å‰ä½¿ç”¨localStorageï¼Œæ•°æ®åªå­˜åœ¨æœ¬åœ°æµè§ˆå™¨<br>';
            html += '2. ä¸åŒè®¾å¤‡/æµè§ˆå™¨æ— æ³•å…±äº«æ•°æ®<br>';
            html += '3. å¯èƒ½å¯¼è‡´é‡å¤æŠ½ç­¾æˆ–æ•°æ®ä¸ä¸€è‡´<br>';
            html += '<br><strong>å»ºè®®è§£å†³æ–¹æ¡ˆï¼š</strong><br>';
            html += 'â€¢ ä½¿ç”¨äº‘ç«¯æ•°æ®åº“ï¼ˆå¦‚Firebaseï¼‰<br>';
            html += 'â€¢ æˆ–ä½¿ç”¨WebSocketå®ç°å®æ—¶åŒæ­¥<br>';
            html += 'â€¢ å½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬ï¼Œå®é™…éƒ¨ç½²éœ€è¦åç«¯æ”¯æŒ<br>';
            html += `<br><strong>å½“å‰æˆ¿é—´æ•°æ®ï¼š</strong><br>${JSON.stringify(retrieved, null, 2)}`;
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }

        function testAdminReset() {
            const resultDiv = document.getElementById('test2-result');
            
            // æ¨¡æ‹Ÿç®¡ç†å‘˜æƒé™æ£€æŸ¥
            const adminUser = { id: 'admin', isAdmin: true };
            const normalUser = { id: 'liztang', isAdmin: false };
            
            function canReset(user) {
                return user && user.isAdmin;
            }
            
            const adminCanReset = canReset(adminUser);
            const userCanReset = canReset(normalUser);
            
            let html = '<div class="success">';
            html += '<strong>âœ… æƒé™æµ‹è¯•ç»“æœï¼š</strong><br>';
            html += `ç®¡ç†å‘˜é‡ç½®æƒé™: ${adminCanReset ? 'âœ… æœ‰æƒé™' : 'âŒ æ— æƒé™'}<br>`;
            html += `æ™®é€šç”¨æˆ·é‡ç½®æƒé™: ${userCanReset ? 'âŒ æœ‰æƒé™ï¼ˆé”™è¯¯ï¼‰' : 'âœ… æ— æƒé™ï¼ˆæ­£ç¡®ï¼‰'}<br>`;
            html += '<br><strong>åŠŸèƒ½ç¡®è®¤ï¼š</strong><br>';
            html += 'â€¢ æƒé™æ£€æŸ¥æ­£å¸¸<br>';
            html += 'â€¢ æœ‰ç¡®è®¤å¯¹è¯æ¡†<br>';
            html += 'â€¢ é‡ç½®åä¼šæ›´æ–°ç•Œé¢<br>';
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>